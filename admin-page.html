<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Poppins, sans-serif;
      margin: 0;
      padding: 15px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
      font-size: 2.3rem;
      margin-top: 20px auto;
      color: #00cc88;
      position: relative;
      top: -35px;
      right: 15px;
      width: 100%;
      padding: 10px;
      border-radius: 9px;
      box-shadow: 0 0 3px rgba(0,0,0,0.01);
    }
    h1 i{
      position: absolute;
      left: 9px;
      margin-left: 8px;
      bottom: 19px;
      font-size: 20px;
      cursor: pointer;
    }
    .welcome { font-size: 14px; font-weight: 200; margin-bottom: 15px; }
    .balance-card {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 50px;
    }
    .balance-header { font-size: 16px; margin-bottom:20px; font-weight: 550; }
    .balance-amount { font-size: 24px; font-weight: 700; margin: 20px 0; }
    .withdraw-btn {
      background: #00cc88;
      color: #fff;
      margin-top: 5px;
      font-size: 10px;
      border: none;
      padding: 10px 18px;
      border-radius: 5px;
      float: right;
      cursor: pointer;
    }
    .transcation-history {
      border: 1px solid #00cc88;
      color: #00cc88;
      margin-top: 7px;
      padding: 5px 10px;
      border-radius: 5px;
      float: left;
      cursor: pointer;
      font-size:15px;
    }
    .approval-tasks {
      max-height:550px;
      overflow-y:auto;
      padding: 5px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
      margin-bottom:30px;
    }
    .project-card {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .project-top { display: flex; justify-content: space-between; align-items: center; }
    .project-code { font-size: 13px; font-weight: 600; color: #00cc88; }
    .project-time { font-size: 11px; color: #777; }
    .project-title { font-size: 16px; font-weight: 600; }
    .project-desc { font-size: 13px; color: #555; line-height: 1.4; }
    .project-reward { font-size: 14px; opacity: 0.6; margin: 6px 0 10px; font-weight: 600; }
    .project-meta {
      display: flex;
      justify-content: space-between;
      background: #f6f6f6;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
    }
    .project-meta span { font-weight: 600; }
    .project-link {
      background: #00cc88;
      color: #fff;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
      margin-top: 5px;
    }
    .slide-panel {
      position: fixed;
      top: 0;
      right: -150%;
      width: 100%;
      max-width: 450px;
      height: 100%;
      background: #f4f4f4;
      box-shadow: -4px 0 15px rgba(0,0,0,0.2);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.35s ease;
      z-index: 999;
    }
    .slide-panel.active { right: -40px; }
    .slide-header { display: flex; justify-content: space-between; width:80%; align-items: center; margin-bottom: 15px; }
    .slide-header h2 { color: #00cc88; margin: 0; }
    #closePanel {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      color: #555;
    }
  #tasksContainer { display: flex; flex-direction: column; gap: 15px; max-width: 800px; margin: 0 auto; width: 90%;
    right:20px; position: relative;
  }
  .task-card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .task-card h4 { margin: 0 0 5px; color: #00cc88; }
  .task-card p { margin: 5px 0; font-size: 14px; color: #555; }
  .task-meta { font-size: 12px; color: #777; margin-bottom: 10px; }
.task-actions {
  display: flex;
  justify-content: space-between; /* spread buttons to edges */
  gap: 10px;                       /* space between buttons */
  margin-top: 15px;
}

.task-actions button {
  flex: 1;                          /* equal width */
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  color: #fff;
}

.task-actions .approve-btn {
  background-color: #00cc88;
}

.task-actions .reject-btn {
  background-color: #ff4d4f;
}
  a.file-link { color: #00cc88; text-decoration: underline; font-size: 14px; }
  input {
    outline:none;
        border:none;
  }
  textarea {
    outline:none;
        border:none;
  }
  .modal-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-message {
  color: #2b2b2b;
  font-weight: bold;
  margin: 20px 0;
  font-size: 14px;
  line-height: 1.4;
}

.modal-buttons button {
  padding: 8px 18px;
  font-size: 14px;
  border:none;
  background:#00cc88;
  border-radius: 6px;
  cursor:pointer;
}
  .modal-contente {
  background: #fff;
  padding: 20px 25px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  max-width: 400px;
  width: 65%;
  text-align: center;
  font-family: Poppins, sans-serif;
}
  </style>
<body>
  <h1>SociHub<i class="fas fa-bars" id="openMenu"></i></h1>
  <div class="welcome">Welcome, <span id="Username">user</span> ðŸ‘‹</div>

  <div class="balance-card">
    <div class="balance-header">Project Fees</div>
    <div class="balance-amount" id="balance">â‚¦0.00</div>
    <button class="transcation-history">View History</button>
    <button class="withdraw-btn">Request payout</button>
    <div style="clear: both"></div>
  </div>
<h3>
  Approvals
  <span id="inProgressCount" style="color:#00cc88; font-size:14px;">
    (0)
  </span>
</h3>
  <div class="approval-tasks" id="approvalsContainer">
    <div class="project-card">Loading...</div>
  </div>

<div id="imageOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  justify-content:center;
  align-items:center;
  z-index:9999;
  cursor: zoom-out;
">
  <img id="overlayImage" src="" style="
    max-width:90%;
    max-height:90%;
    transform: scale(1);
    transition: transform 0.3s;
    cursor: grab;
  ">
</div>

  <!-- Slide-in panel -->
  <div id="taskPanel" class="slide-panel">
    <div class="slide-header">
      <h2>Pending Tasks</h2>
      <button id="closePanel">&times;</button>
    </div>
    <div id="tasksContainer">Loading tasks...</div>
  </div>
  
  <div id="alertModal" class="modal-overlay" style="display:none;">
  <div class="modal-contente">
    <div id="alertModalMessage" class="modal-message"></div>
    <div class="modal-buttons">
      <button id="alertModalOkBtn">OK</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, orderBy, getCountFromServer, where, updateDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAK4b3ASYB0USFC6cNQiQ9DA3_ROS48RYI",
  authDomain: "socihub-a2731.firebaseapp.com",
  projectId: "socihub-a2731",
  storageBucket: "socihub-a2731.firebasestorage.app",
  messagingSenderId: "815252223754",
  appId: "1:815252223754:web:99a26383a59c2557412cf3",
  measurementId: "G-KXW58D7RGM"
};

/* ================= INITIALIZE FIREBASE ================= */
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= DOM ELEMENTS ================= */
const taskPanel = document.getElementById("taskPanel");
const closePanel = document.getElementById("closePanel");
const tasksContainer = document.getElementById("tasksContainer");
const approvalsContainer = document.getElementById("approvalsContainer");
const usernameDisplay   = document.getElementById("Username");
const balanceDisplay    = document.getElementById("balance");

const REQUIRED_ROLE = "admin";

/* ================= PANEL CONTROL ================= */
// Keep track of open panels
const pageStack = [];

// Open task panel
function openTasks(projectId) {
  taskPanel.classList.add("active");
  pageStack.push("taskPanel");
  history.pushState({ panelOpen: true }, "");
  loadTasks(projectId);
}

// Close task panel manually
closePanel.onclick = () => {
  taskPanel.classList.remove("active");
  const index = pageStack.indexOf("taskPanel");
  if (index > -1) pageStack.splice(index, 1);
};

// Detect back gesture / browser back button
window.addEventListener("popstate", (e) => {
  // 1ï¸âƒ£ Close overlay if open
  if (overlay.style.display === "flex") {
    overlay.style.display = "none";
    overlayImg.src = "";
    scale = 1;
    return;
  }

  // 2ï¸âƒ£ Close last panel if any
  if (pageStack.length > 0) {
    const lastPage = pageStack.pop();
    const panel = document.getElementById(lastPage);
    if (panel) panel.classList.remove("active");
    return;
  }

  // 3ï¸âƒ£ If nothing to close, go back normally
  history.back();
});

// Optional: replace initial state to prevent immediate back
history.replaceState({ initial: true }, "");

function showAlertModal(message, okBtn = true) {
  return new Promise(resolve => {
    const modal = document.getElementById("alertModal");
    const msg = document.getElementById("alertModalMessage");
    const okButton = document.getElementById("alertModalOkBtn");

    msg.textContent = message;

    if (okBtn) {
      okButton.style.display = "inline-block";
    } else {
      okButton.style.display = "none";
    }

    // Show modal
    modal.style.display = "flex";

    // OK button click
    okButton.onclick = () => {
      modal.style.display = "none";
      resolve(true);
    };

    // Click outside modal to close (optional)
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
        resolve(false);
      }
    };
  });
}
/* ================= LOAD TASKS ================= */
async function loadTasks(projectId) {
  tasksContainer.innerHTML = "Loading tasks...";

  const tasksQuery = query(
    collection(db, "tasks"),
    where("projectId", "==", projectId),
    where("status", "==", "Pending")
  );

onSnapshot(tasksQuery, snapshot => {
  tasksContainer.innerHTML = "";

  if (snapshot.empty) {
    tasksContainer.innerHTML = "<p>No pending tasks.</p>";
    return;
  }

  snapshot.forEach(docSnap => {
    const task = docSnap.data();
    const taskId = docSnap.id;
    const submittedAt = task.submission?.submittedAt?.toDate
      ? task.submission.submittedAt.toDate().toLocaleString()
      : "-";

    // File preview logic
    let filePreviewHTML = "";
    if (task.submission?.fileURL) {
      const fileURL = task.submission.fileURL;
      const fileType = task.submission.fileType || "";
      if (fileType.startsWith("image/")) {
        filePreviewHTML = `<img src="${fileURL}" alt="Submission" class="submission-preview" style="max-width:200px; max-height:200px; display:block; margin:10px 0;">`;
      } else if (fileType.startsWith("video/")) {
        filePreviewHTML = `<video src="${fileURL}" controls class="submission-preview" style="max-width:200px; max-height:200px; display:block; margin:10px 0;"></video>`;
      } else {
        filePreviewHTML = `<a href="${fileURL}" target="_blank">View Submission</a>`;
      }
    }

    const card = document.createElement("div");
    card.className = "task-card";
    card.innerHTML = `
      <h4>${task.title}</h4>
      <p>${task.description}</p>
      <p class="task-meta">Submitted by: <strong>${task.submission?.submittedByName || 'Unknown'}</strong> | At: ${submittedAt}</p>
      ${task.link ? `<div class="link" data-link="${task.link}">Open Link</div>` : ""}
      ${filePreviewHTML}
      <div class="task-actions">
        <button class="approve-btn">Approve</button>
        <button class="reject-btn">Reject</button>
      </div>
    `;

    // Open task link in new tab
    if (task.link) {
      const linkDiv = card.querySelector(".link");
      linkDiv.addEventListener("click", e => {
        e.stopPropagation();
        window.open(task.link, "_blank");
      });
    }

    // Approve button
    card.querySelector(".approve-btn").addEventListener("click", async () => {
      try {
        const taskRef = doc(db, "tasks", taskId);
        const taskSnap = await getDoc(taskRef);
        if (!taskSnap.exists()) throw new Error("Task not found");

        const taskData = taskSnap.data();
        const reward = Number(taskData.reward || 0);
        const adminId = taskData.adminId;
        const earnerId = taskData.submission?.submittedBy;
        if (!adminId || !earnerId) throw new Error("Admin or earner missing");
        if (reward <= 0) throw new Error("Invalid reward amount");

        const [adminSnap, earnerSnap] = await Promise.all([
          getDoc(doc(db, "users", adminId)),
          getDoc(doc(db, "users", earnerId))
        ]);

        if (!adminSnap.exists() || !earnerSnap.exists())
          throw new Error("User account not found");

        const adminBalance = Number(adminSnap.data().balance || 0);
        const earnerBalance = Number(earnerSnap.data().balance || 0);
        if (adminBalance < reward) throw new Error("Admin has insufficient balance");

        const batch = writeBatch(db);
        batch.update(taskRef, { status: "Completed", approvedAt: new Date(), approvedBy: adminId });
        batch.update(doc(db, "users", adminId), { balance: adminBalance - reward });
        batch.update(doc(db, "users", earnerId), { balance: earnerBalance + reward });

        await batch.commit();
        await reloadAdminBalance();
        await reloadInProgressCount(adminId);
        reloadApprovalProjects();
        await showAlertModal("Task approved and reward transferred successfully!");
      } catch (err) {
        console.error("Approve task error:", err);
        await showAlertModal(err.message);
      }
    });

    // Reject button
    card.querySelector(".reject-btn").addEventListener("click", async () => {
      try {
        await updateDoc(doc(db, "tasks", taskId), { status: "rejected" });
        await showAlertModal("Task rejected");
      } catch (err) {
        console.error("Reject error:", err);
      }
    });

    tasksContainer.appendChild(card);
  });
});
}

/* ================= RENDER PROJECTS ================= */
function renderProject(project){
  const card = document.createElement("div");
  card.className = "project-card";
  card.dataset.projectId = project.id;

  const time = project.createdAt?.toDate ? project.createdAt.toDate().toLocaleString() : "â€”";

  card.innerHTML = `
    <div class="project-top">
      <div class="project-code">${project.projectCode}</div>
      <div class="project-time">${time}</div>
    </div>
    <div class="project-title">${project.title}</div>
    <textarea rows="4" class="project-desc" readonly>${project.description}</textarea>
    <div class="project-reward">Reward: <strong>â‚¦${project.reward}</strong></div>
    <div class="project-meta">
      <div>Pending: <span class="pending-count">0</span> / ${project.engagers}</div>
      <div>Completed: <span class="completed-count">0</span> / ${project.engagers}</div>
    </div>
    ${project.link ? `<div class="link" data-link="${project.link}">Open Link</div>` : ""}
    <div class="project-link">Open</div>
      <p style="font-size:12px; color:#777;">
      Created by: <strong>${project.createdByName || "Unknown client"}</strong>
    </p>
  `;
  if (project.link) {
  const linkDiv = card.querySelector(".link");
  linkDiv.addEventListener("click", (e) => {
    e.stopPropagation(); // prevent card's click event from firing
    window.open(project.link, "_blank"); // opens in new tab
  });
}
  card.querySelector(".project-link").onclick = () => openTasks(project.id);
  approvalsContainer.appendChild(card);

  attachProjectStats(project.id, card, project.engagers);
}

async function reloadAdminBalance() {
  const user = auth.currentUser;
  if (!user) return;

  const adminRef = doc(db, "users", user.uid);
  const adminSnap = await getDoc(adminRef);

  if (adminSnap.exists()) {
    const balance = adminSnap.data().balance ?? 0;
    balanceDisplay.textContent = "â‚¦" + Number(balance).toLocaleString();
  }
}
async function reloadInProgressCount(adminId) {
  await loadInProgressCount(adminId);
}

function reloadApprovalProjects() {
  loadApprovalProjects();
}
/* ================= LOAD IN-PROGRESS PROJECTS ================= */
async function loadInProgressCount(adminId) {
  const countEl = document.getElementById("inProgressCount");

  const q = query(
    collection(db, "projects"),
    where("projectStatus", "==", "in-progress"),
    where("adminId", "==", adminId)
  );

  const snap = await getCountFromServer(q);
  countEl.textContent = `(${snap.data().count})`;
}
function loadApprovalProjects(adminId) {
  const projectsRef = collection(db, "projects");

  // Query only your projects in-progress
  const q = query(
    projectsRef,
    where("projectStatus", "==", "in-progress"),
    where("createdBy", "==", adminId), // <-- filter by your UID
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, snapshot => {
    approvalsContainer.innerHTML = "";
    if (snapshot.empty) {
      approvalsContainer.innerHTML = "<p>No Project Created</p>";
      return;
    }

    snapshot.forEach(docSnap => {
      renderProject({ id: docSnap.id, ...docSnap.data() });
    });
  });
}

/* ================= AUTHENTICATION ================= */
onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href="1page.html";
  try{
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists() || userSnap.data().role !== REQUIRED_ROLE)
      return window.location.href="no_access.html";

    const userData = userSnap.data();
    usernameDisplay.textContent = userData.name || "user";
    balanceDisplay.textContent = "â‚¦" + (userData.balance ?? 0).toLocaleString(2);
    loadApprovalProjects(user.uid);
    loadInProgressCount(user.uid); 
  } catch(err){
    console.error(err);
    window.location.href="no_access.html";
  }
});

/* ================= ATTACH PROJECT STATS ================= */
async function attachProjectStats(projectId, card, totalEngagers){
  const tasksRef = collection(db,"tasks");
  const pendingQuery = query(tasksRef, where("projectId","==",projectId), where("status","==","Pending"));
  const completedQuery = query(tasksRef, where("projectId","==",projectId), where("status","==","Completed"));

  const [pendingSnap, completedSnap] = await Promise.all([getCountFromServer(pendingQuery), getCountFromServer(completedQuery)]);
  const pendingCount = pendingSnap.data().count;
  const completedCount = completedSnap.data().count;

  card.querySelector(".pending-count").textContent = pendingCount;
  card.querySelector(".completed-count").textContent = completedCount;

  if(completedCount >= totalEngagers){
    const projectRef = doc(db,"projects",projectId);
    const projectSnap = await getDoc(projectRef);
    if(projectSnap.exists() && projectSnap.data().projectStatus !== "completed"){
      await updateDoc(projectRef,{projectStatus:"completed",completedAt:new Date()});
    }
  }
}

const overlay = document.getElementById("imageOverlay");
const overlayImg = document.getElementById("overlayImage");
let scale = 1;

// Function to open overlay
function openOverlay(src) {
  overlay.style.display = "flex";
  overlayImg.src = src;
  scale = 1;
  overlayImg.style.transform = `scale(${scale})`;

  // Push state so back button can close it
  history.pushState({ overlayOpen: true }, "");
}

// Function to close overlay
function closeOverlay() {
  overlay.style.display = "none";
  overlayImg.src = "";
  scale = 1;

  // Remove the pushed state if any
  if (history.state?.overlayOpen) history.back();
}

// Open overlay when clicking thumbnail
tasksContainer.addEventListener("click", e => {
  const img = e.target.closest(".submission-preview");
  if (!img) return;
  openOverlay(img.src);
});

// Close overlay when clicking background
overlay.addEventListener("click", closeOverlay);

// Zoom with mouse wheel (desktop)
overlayImg.addEventListener("wheel", e => {
  e.preventDefault();
  if (e.deltaY < 0) scale += 0.1;
  else scale = Math.max(1, scale - 0.1);
  overlayImg.style.transform = `scale(${scale})`;
});

</script>
</body>
</html>