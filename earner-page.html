<!DOCTYPE html>  <html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">      
  <title>SociHub Home</title>  
  <style>  
    body {  
      font-family: Poppins, sans-serif;  
      margin: 0;  
      padding: 15px;  
      background: #f4f4f4;  
    }  
    .welcome {  
  font-size: 14px;  
  font-weight: 200;  
  margin-bottom: 15px;  
}  .balance-card {
background: #fff;
padding: 15px;
border-radius: 12px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
margin-bottom: 50px;
}

.balance-header {
font-size: 18px;
font-weight: 600;
}

.balance-amount {
font-size: 24px;
font-weight: 700;
margin: 10px 0;
}

.withdraw-btn {
background: #00cc88;
color: #fff;
font-size: 10px;
border: none;
padding: 10px 18px;
border-radius: 5px;
float: right;
cursor: pointer;
}
.transcation-history {
border: 1px solid #00cc88;
color: #00cc88;
margin-top: 7px;
padding: 5px 10px;
border-radius: 5px;
float: left;
cursor: pointer;
font-size:10px;
}
.stats-section {
margin-bottom: 30px ;
}

.stats-wrapper {
margin-top: 50px;
margin-bottom: 60px;
display: flex;
gap: 10px;
}

/* LEFT PERCENTAGE LABELS */
.percent-labels {
position: relative;
left: 0;
bottom: 25px;
display: flex;
flex-direction: column;
justify-content: space-between;
gap: 6px;
height: 180px;
font-size: 10px;
color: #666;
}

/* AREA HOLDING LINES + BARS */
.stats-area {
position: relative;
width: 100%;
}

/* HORIZONTAL GUIDE LINES */
.horizontal-lines {
position: absolute;
left: 0;
top: -17px;
width: 100%;
height: 180px;
display: flex;
flex-direction: column;
justify-content: space-between;
pointer-events: none;
}

.horizontal-lines div {
width: 100%;
height: 1px;
background: #ccc; /* Line color */
opacity: 0.4;
}

/* BARS */
.stats-bars {
display: flex;
justify-content: space-between;
align-items: flex-end;
height: 180px;
padding-left: 10px;
}

.bar {
width: 20px;
border-radius: 6px 6px 0 0;
position: relative;
z-index: 5;   /* âœ… BAR COMES FRONT */
}

/* LABEL UNDER BAR */
.bar-label {
margin-top: 5px;
font-size: 10px;
text-align: center;
margin-left: -10px;
}

.pending-tasks, .Available-tasks {
background: #fff;
padding: 15px;
border-radius: 12px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
margin-bottom: 20px;
}

.task-item {
padding: 10px 0;
border-bottom: 1px solid #eee;
font-size: 15px;
}

.task-item:last-child {
border-bottom: none;
}

.Available-header {
font-size: 16px;
font-weight: 600;
margin-bottom: 10px;
}
h1 {
text-align: center;
font-size: 2.3rem;
margin-top: 20px auto;
color: #00cc88;
position: relative;
top: -35px;
right: 15px;
width: 100%;
padding: 10px;
border-radius: 9px;
box-shadow: 0 0 3px rgba(0,0,0,0.01);
}
h1 i{
position: absolute;
left: 9px;
margin-left: 8px;
bottom: 19px;
font-size: 20px;
}
/* Slide-out Menu Panel */
.side-menu {
position: fixed;
top: 0;
left: -70%;
width: 40%;
height: 100%;
background-color: #f0f0f0;
transition: left 0.4s ease, background-color 0.3s ease;
z-index: 999;
padding: 20px 15px;
}

.side-menu.active {
left: 0;
}

.side-menu .close-menu {
font-size: 18px;
color: #00cc88;
cursor: pointer;
margin-bottom: 20px;
}

.side-menu ul {
list-style: none;
padding: 0;
}

.side-menu li {
margin-bottom: 20px;
color: black;
font-size: 14px;
display: flex;
align-items: center;
gap: 10px;
}
.side-menu li i {
color: #00cc88;
}
.stats-bars {
display: flex;
justify-content: space-between;
align-items: flex-end;
height: 180px;
padding-left: 10px;
}

.bar-container {
text-align: center;
}

.bar {
width: 20px;
border-radius: 6px 6px 0 0;
height: 0; /* initial, will grow dynamically */
}

.bar.Available { background: blue; }
.bar.completed { background: #00cc88; }
.bar.rejected { background: red; }
.bar.pending { background: #e8d400b7; }
.bar.flagged { background: black; }
.stats-bars {
height: 180px;
}
.tasks-container {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  display: flex;
  flex-direction: column;
  gap: 10px;
max-height:550px;
overflow-x:scroll;
display: flex;
flex-direction: column;
gap: 15px;
margin-top: 30px;
margin-bottom:60px;
}

.task-card {
background: #fff;
border-radius: 12px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
padding: 15px;
transition: transform 0.2s ease, box-shadow 0.2s ease;
position: relative;

}

.task-card:hover {
transform: translateY(-3px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.task-card h3 {
margin: 0 0 40px 0;
color: #00cc88;
font-size: 1.2rem;
}

.descc{
  outline:none;
}

.task-card p {
font-size: 15px;
margin: 30px 0;
  line-height: 1.5;

  display: -webkit-box;
  -webkit-line-clamp: 3;     /* number of lines */
  -webkit-box-orient: vertical;
  text-overflow: ellipsis;
}

.task-card .task-link {
display: inline-block;
margin: 5px 0 10px 0;
color: #0066cc;
text-decoration: underline;
font-size: 14px;
}

.task-card input[type="file"] {
margin-top: 9px;
color:red;
}

.complete-task-btn {
background: #00cc88;
color: #fff;
border: none;
padding: 10px 15px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
margin-top: 20px;
width: 100%;
position: relative;
  min-width: 140px;
}
  input {
    outline:none;
        border:none;
  }
  textarea {
    
    line-height: 1.7;
    outline:none;
        border:none;
  }
.complete-task-btn:hover {
background: #00b377;
}

.task-status {
position: absolute;
top: 12px;
right: 12px;
padding: 3px 8px;
font-size: 12px;
border-radius: 8px;
color: #fff;
}
.task-status.pending {
  background: #ffcb30f0;
  color: white;
}
.task-status.available { background: blue; }
.task-status.completed { background: #5cb85c; }
.task-status.rejected { background: red; }
.bar {
transition: height 0.5s ease;
}
.task-status.flagged{
background: black;
}
.report-btn {
position: absolute;
top: 45px;
left: 15px;
color: #999;
font-size: 16px;
cursor: pointer;
z-index: 5;
}

.report-btn:hover {
color: red;
}
.report-modal {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.5);
z-index: 3000;
align-items: center;
justify-content: center;
}

.modal-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-message {
  color: #2b2b2b;
  font-weight: bold;
  margin: 20px 0;
  font-size: 14px;
  line-height: 1.4;
}

.modal-buttons button {
  padding: 8px 18px;
  font-size: 14px;
  border:none;
  background:#00cc88;
  border-radius: 6px;
  cursor:pointer;
}
.modal-contente {
  background: #fff;
  padding: 20px 25px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  max-width: 400px;
  width: 65%;
  text-align: center;
  font-family: Poppins, sans-serif;
}
.report-box {
background: #fff;
width: 90%;
max-width: 320px;
padding: 20px;
border-radius: 12px;
}

.report-actions {
margin-top: 15px;
display: flex;
gap: 10px;
}

.report-actions button {
flex: 1;
padding: 10px;
border: none;
border-radius: 8px;
cursor: pointer;
}

#submitReport {
background: red;
color: white;
}

#closeReport {
background: #ccc;
}
.task-status.suspended {
  background: #ff4500;
  color: #fff;
}

.task-card.suspended {
  opacity: 0.5;
  border: 2px solid #ff4500;
}
.complete-task-btn.loading {
  pointer-events: none;
  opacity: 0.7;
}

.complete-task-btn .spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,.4);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin .8s linear infinite;
  display: inline-block;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

</head>  
<body>  
  <h1>SociHub<i class="fas fa-bars icon left-icon" id="openMenu"></i></h1>  
      <!-- Slide-out Menu -->  <div id="side-menu" class="side-menu">          
  <i class="fas fa-arrow-left close-menu"></i>          
  <ul>          
    <li><i id="userIcon" class="fas fa-user"></i> <span id="userId">Profile</span></li>  
    <li><i class="fas fa-user-friends" style="font-size: 12px;"></i><span id="referral">Referrals</span></li>  
    <li>    
  <i class="fas fa-adjust"></i><span onclick="toggleTheme()">Themes</span><span class="theme-toggle-icon">          
 </span>          
</li>         
    <li><i class="fas fa-cog"></i><span id="settings">Settings</span></li>     
    <li><i class="fa fa-circle-info"></i><span id="About">About</span></li>   
            <li><i class="fa-solid fa-headset"></i><span id="contact">Contact us</span></li>    
<li><i class="fas fa-sign-out-alt"></i><span id="logoutBtn">Logout</span></li>  
  </ul>          
</div>    
  <div class="welcome">Welcome, <span id="Username">user</span> ðŸ‘‹</div>  <div class="balance-card">  
    <div class="balance-header">Balance</div>  
    <div class="balance-amount" id="balance">â‚¦0.00</div>  
    <button class="transcation-history">Transcations</button>  
    <button class="withdraw-btn">Withdraw</button>  
    <div style="clear: both"></div>  
  </div>  <div class="stats-section">  
    <h3>Task Statistics</h3>  <div class="stats-wrapper">  
  <!-- LEFT PERCENTAGE LABELS -->  
  <div class="percent-labels">  
    <div>100%</div>  
    <div>90%</div>  
    <div>80%</div>  
    <div>70%</div>  
    <div>60%</div>  
    <div>50%</div>  
    <div>40%</div>  
    <div>30%</div>  
    <div>20%</div>  
    <div>10%</div>  
    <div style="margin-left:4px;">0%</div>  
  </div>    <!-- BARS + HORIZONTAL LINES -->    <div class="stats-area">  
    <div class="horizontal-lines">  
      <div></div><div></div><div></div><div></div><div></div>  
      <div></div><div></div><div></div><div></div><div></div><div></div>  
    </div>  <div class="stats-bars">  
  <div class="bar-container">  
    <div class="bar Available"></div>  
    <div class="bar-label">Available</div>  
  </div>    <div class="bar-container">  
    <div class="bar completed"></div>  
    <div class="bar-label">Completed</div>  
  </div>    <div class="bar-container">  
    <div class="bar rejected"></div>  
    <div class="bar-label">Rejected</div>  
  </div>    <div class="bar-container">  
    <div class="bar pending"></div>  
    <div class="bar-label">Pending</div>  
  </div>    <div class="bar-container">  
    <div class="bar flagged"></div>  
    <div class="bar-label">Flagged</div>  
  </div>  
</div>  
  </div>  
</div>  
  </div>   
  <div id="tasksHeader" style="margin-bottom:15px; font-weight:600; font-size:16px;">  
  Available Tasks: <span id="AvailableCount">0</span>  
</div>  
  <div id="tasksContainer" class="tasks-container"><span style="margin: 0 auto; padding:50px;">Loading...</span></div> 
   <div id="tasksHeader" style="margin-bottom:15px; font-weight:600; font-size:16px;">  
  Completed Tasks: <span id="completedCount">0</span>  
</div>   
  <div id="tasksCompleted" class="tasks-container"><span style="margin: 0 auto; padding:50px;">Loading...</span></div></div>
    <div id="tasksHeader" style="margin-bottom:15px; font-weight:600; font-size:16px; margin-left:3px;">  
  Rejected Tasks:  <span id="rejectedCount">0</span>  
</div>   
  <div id="tasksRejected" class="tasks-container" ><span style="margin: 0 auto; padding:50px;">Loading...</span></div> </div>
     <div id="tasksHeader" style="margin-bottom:15px; font-weight:600; font-size:16px;">  
  Pending Tasks: <span id="pendingCount">0</span>  
</div>   
  <div id="tasksPending" class="tasks-container"><span style="margin: 0 auto; padding:50px;">Loading...</span></div> </div>
     <div id="tasksHeader" style="margin-bottom:15px; font-weight:600; font-size:16px;">  
  Flagged Tasks: <span id="flaggedCount">0</span>  
</div>   
  <div id="tasksflagged" class="tasks-container"><span style="margin: 0 auto; padding:50px;">Loading...</span></div> 
</div>
  <!-- REPORT MODAL -->  
<div id="reportModal" style="  
  display:none;  
  position:fixed;  
  inset:0;  
  background:rgba(0,0,0,0.5);  
  z-index:2000;  
  align-items:center;  
  justify-content:center;  
">  
  <div style="  
    background:#fff;  
    width:90%;  
    max-width:320px;  
    padding:20px;  
    border-radius:12px;  
  ">  
    <h3 style="margin-top:0;">Report Task</h3>  <label style="display:block;margin-bottom:8px;">  
  <input type="radio" name="reportReason" value="Invalid link">  
  Invalid link  
</label>  

<label style="display:block;margin-bottom:8px;">  
  <input type="radio" name="reportReason" value="Didn't understand the description">  
  Didn't understand the description  
</label>  

<div style="margin-top:15px;display:flex;gap:10px;">  
  <button id="submitReport" style="  
    flex:1;  
    background:red;  
    color:#fff;  
    border:none;  
    padding:10px;  
    border-radius:8px;  
    cursor:pointer;">Submit</button>  

  <button id="closeReport" style="  
    flex:1;  
    background:#ccc;  
    border:none;  
    padding:10px;  
    border-radius:8px;  
    cursor:pointer;  
  ">Cancel</button>  
</div>

  </div>  
</div>  
<div id="alertModal" class="modal-overlay" style="display:none;">
  <div class="modal-contente">
    <div id="alertModalMessage" class="modal-message"></div>
    <div class="modal-buttons">
      <button id="alertModalOkBtn">OK</button>
    </div>
  </div>
</div>
<script type="module">  
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";  
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";  
import { getFirestore, collection, query, where, doc, getDoc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";  
  
// ---------------- FIREBASE CONFIG ----------------  
const firebaseConfig = {  
  apiKey: "AIzaSyAK4b3ASYB0USFC6cNQiQ9DA3_ROS48RYI",  
  authDomain: "socihub-a2731.firebaseapp.com",  
  projectId: "socihub-a2731",  
  storageBucket: "socihub-a2731.firebasestorage.app",  
  messagingSenderId: "815252223754",  
  appId: "1:815252223754:web:99a26383a59c2557412cf3",  
  measurementId: "G-KXW58D7RGM"  
};  
  
const REQUIRED_ROLE = "earner";  
  
// ---------------- INITIALIZE FIREBASE ----------------  
const app = initializeApp(firebaseConfig);  
const auth = getAuth(app);  
const db = getFirestore(app);  
  
// ---------------- DOM ELEMENTS ----------------  
const usernameDisplay = document.getElementById("Username");  
const balanceDisplay = document.getElementById("balance");  
const AvailableContainer = document.getElementById("tasksContainer");  
const completedContainer = document.getElementById("tasksCompleted");  
const rejectedContainer = document.getElementById("tasksRejected");  
const pendingContainer = document.getElementById("tasksPending");  
const flaggedContainer = document.getElementById("tasksflagged");  
const pendingCountEl = document.getElementById("pendingCount"); 
const AvailableCountEl = document.getElementById("AvailableCount");
const completedCountEl = document.getElementById("completedCount");
const rejectedCountEl = document.getElementById("rejectedCount");   
const flaggedCountEl = document.getElementById("flaggedCount"); 
  
const MAX_BAR_HEIGHT = 180;  
const barElements = {  
  Available: document.querySelector(".bar.Available"),  
  completed: document.querySelector(".bar.completed"),  
  rejected: document.querySelector(".bar.rejected"),  
  pending: document.querySelector(".bar.pending"),  
  flagged: document.querySelector(".bar.flagged")  
};  
  
  function showAlertModal(message, okBtn = true) {
  return new Promise(resolve => {
    const modal = document.getElementById("alertModal");
    const msg = document.getElementById("alertModalMessage");
    const okButton = document.getElementById("alertModalOkBtn");

    msg.textContent = message;

    if (okBtn) {
      okButton.style.display = "inline-block";
    } else {
      okButton.style.display = "none";
    }

    // Show modal
    modal.style.display = "flex";

    // OK button click
    okButton.onclick = () => {
      modal.style.display = "none";
      resolve(true);
    };

    // Click outside modal to close (optional)
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
        resolve(false);
      }
    };
  });
}
// ---------------- MENU LOGIC ----------------  
const menuBtn = document.getElementById("openMenu");  
const closeBtn = document.querySelector(".close-menu");  
const sideMenu = document.getElementById("side-menu");  
  
menuBtn.addEventListener("click", () => sideMenu.classList.add("active"));  
closeBtn.addEventListener("click", () => sideMenu.classList.remove("active"));  
document.addEventListener("click", (event) => {  
  if (sideMenu.classList.contains("active") && !sideMenu.contains(event.target) && event.target !== menuBtn) {  
    sideMenu.classList.remove("active");  
  }  
});  
  
// ---------------- CONTAINERS MAP ----------------  
const containers = {  
  Available: AvailableContainer,  
  suspended: AvailableContainer, // Suspended stays with Available  
  completed: completedContainer,  
  rejected: rejectedContainer,  
  pending: pendingContainer,  
  flagged: flaggedContainer  
};  
  
// ---------------- CREATE TASK CARD ----------------  
function createTaskView(taskData) {
  const status = taskData.status || "Available";
  const lowerStatus = status.toLowerCase();
  const container = containers[lowerStatus] || AvailableContainer;

  // Create task card
  const taskDiv = document.createElement("div");
  taskDiv.classList.add("task-card", lowerStatus);
  taskDiv.innerHTML = `
    <i class="fa-solid fa-thumbs-down report-btn"></i>
    <span class="task-status ${lowerStatus}">${status}</span>
    <h3>${taskData.title}</h3>
      <textarea class="descc" rows="4" readonly> ${taskData.description}</textarea> 
    <p><strong>Reward:</strong> â‚¦${taskData.reward}</p>
    <a href="${taskData.link}" target="_blank" class="task-link">Open Post</a>
    <div class="submission-area">
      <label class="upload-label">Upload Proof</label>
      <input type="file" accept="image/*,video/*" class="proof-input">
      <button class="complete-task-btn" disabled>Submit Task</button>
    </div>
  `;

  // Append based on status
  if (lowerStatus === "suspended") {
    // Suspended tasks go after all existing children in Available container
    container.appendChild(taskDiv);
  } // Append based on status
if (lowerStatus === "Available" || lowerStatus === "suspended") {
  // Collect existing suspended tasks
  const suspendedTasks = container.querySelectorAll(".task-card.suspended");
  if (lowerStatus === "Available") {
    // Available goes before first suspended task (if any), else at end
    if (suspendedTasks.length > 0) {
      container.insertBefore(taskDiv, suspendedTasks[0]);
    } else {
      container.appendChild(taskDiv);
    }
  } else {
    // Suspended always goes last
    container.appendChild(taskDiv);
  }
} else {
  // All other statuses
  container.appendChild(taskDiv);
}

  // DOM elements
  const reportBtn = taskDiv.querySelector(".report-btn");
  const fileInput = taskDiv.querySelector(".proof-input");
  const submitBtn = taskDiv.querySelector(".complete-task-btn");
  const submissionArea = taskDiv.querySelector(".submission-area");
  const taskLink = taskDiv.querySelector(".task-link");

  // Report button
  reportBtn.addEventListener("click", () => openReportModal(taskData.id));

  // Status-based visibility
  if (status === "Available") {
    fileInput.addEventListener("change", () => {
      submitBtn.disabled = !fileInput.files.length;
    });
  }

  if (status === "Pending") {
    const uploadLabel = submissionArea.querySelector(".upload-label");
    if (uploadLabel) uploadLabel.style.display = "none";
    reportBtn.style.display = "none";
    fileInput.style.display = "none";
    submitBtn.style.display = "none";
    if (taskLink) taskLink.style.display = "none";

    if (taskData.submission?.fileName) {
      const fileViewLink = document.createElement("a");
      fileViewLink.href = taskData.submission.fileURL || "#";
      fileViewLink.target = "_blank";
      fileViewLink.textContent = `View uploaded file`;
      fileViewLink.style.display = "block";
      fileViewLink.style.marginTop = "10px";
      submissionArea.appendChild(fileViewLink);
    }
  }

  if (status === "Completed" || status === "Suspended") {
    reportBtn.style.display = "none";
    submissionArea.style.display = "none";
    if (taskLink) taskLink.style.display = "none";
  }
    if (status === "flagged") {
    reportBtn.style.display = "none";
    submissionArea.style.display = "none";
  }
if (status === "Rejected") {
    reportBtn.style.display = "none";
}
  // Submit logic
if (status === "Available") {
submitBtn.addEventListener("click", async () => {
  if (!fileInput.files.length) return;

  // Lock button and show spinner
  setButtonLoading(submitBtn, true);

  const user = auth.currentUser;
  if (!user) {
    await showAlertModal("Not authenticated");
    setButtonLoading(submitBtn, false);
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const taskRef = doc(db, "tasks", taskData.id);

  try {
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) throw new Error("User not found");

    const userData = userSnap.data();
    const file = fileInput.files[0];

    // Upload with 60s timeout
    const fileURL = await withTimeout(
      uploadToCloudinary(file, { preset: "deposit_preset", cloudName: "dp0qteuda" }),
      60000
    );

    await updateDoc(taskRef, {
      status: "Pending",
      submission: {
        taskId: taskData.id,
        projectCode: taskData.projectCode || null,
        submittedBy: user.uid,
        submittedByName: userData.name || "Unknown",
        assignedTo: user.uid,
        submittedAt: new Date(),
        fileName: file.name,
        fileType: file.type,
        fileSize: file.size,
        fileURL
      }
    });

    await showAlertModal("Task submitted and pending review");

  } catch (err) {
    console.error(err);

    // Show â€œTry againâ€ inside button after failure
    submitBtn.textContent = "Try again";
    submitBtn.disabled = false;

    // Optional: show alert too
    await showAlertModal(err.message || "Upload failed. Please try again.");

  } finally {
    // Reset spinner if needed, only if you want
    if (!submitBtn.disabled) setButtonLoading(submitBtn, false);
  }
});
}
}
 async function uploadToCloudinary(
  file,
  {
    cloudName = "dp0qteuda",
    preset = "deposit_preset",
    timeout = 60000
  } = {}
) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeout);

  try {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", preset);

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${cloudName}/upload`,
      {
        method: "POST",
        body: formData,
        signal: controller.signal
      }
    );

    if (!res.ok) {
      throw new Error("Network error while uploading");
    }

    const data = await res.json();

    if (data.error) {
      throw new Error(data.error.message || "Cloudinary upload failed");
    }

    if (!data.secure_url) {
      throw new Error("Upload succeeded but no file URL returned");
    }

    return data.secure_url;

  } catch (err) {
    if (err.name === "AbortError") {
      throw new Error("Upload timed out. Please try again.");
    }
    throw err;
  } finally {
    clearTimeout(timer);
  }
} 
// ---------------- EMPTY STATE ----------------  
function showEmptyState(container, text) {  
  if (!container.children.length) {  
    container.innerHTML = `<p style="text-align:center; font-size:13px; color:#999; padding:20px 10px;">${text}</p>`;  
  }  
  // Always show flagged warning  
  if (container === flaggedContainer) {  
    const warningMessage = document.createElement("p");  
    warningMessage.style.color = "red";  
    warningMessage.style.fontSize = "10px";  
    warningMessage.innerHTML = '<i class="fas fa-warning" style="color: orange;"></i> If you\'re being flagged for a post thrice, your account will be banned.';  
    container.appendChild(warningMessage);  
  }  
}  
  
// ---------------- LOAD TASKS ----------------  
function loadTasksForEarner() {    
  const tasksRef = collection(db, "tasks");    
  const q = query(tasksRef, where("assignedTo", "==", auth.currentUser.uid));    

  onSnapshot(q, (querySnap) => {    
    // Clear all containers first    
    Object.values(containers).forEach(c => c.innerHTML = "");    

    const tasks = [];
    querySnap.forEach(docSnap => {
      const t = { id: docSnap.id, ...docSnap.data() };
      // âŒ Skip hidden tasks
      if (t.status === "hidden") return;
      tasks.push(t);
    });    

    tasks.forEach(task => createTaskView(task));    

    // Count statuses    
    const completed = tasks.filter(t => t.status === "Completed").length;    
    const pending = tasks.filter(t => t.status === "Pending").length;    
    const Available = tasks.filter(t => t.status === "Available").length;    
    const rejected = tasks.filter(t => t.status === "rejected").length;    
    const flagged = tasks.filter(t => t.status === "flagged").length;    

    AvailableCountEl.textContent = Available;   
    rejectedCountEl.textContent = rejected;    
    completedCountEl.textContent = completed;    
    pendingCountEl.textContent = pending;  
    flaggedCountEl.textContent = flagged;     

    // Update bars    
    barElements.Available.style.height = Math.min(Available * 0.5, 100) / 100 * MAX_BAR_HEIGHT + "px";    
    barElements.completed.style.height = Math.min(completed * 2, 100) / 100 * MAX_BAR_HEIGHT + "px";    
    barElements.pending.style.height = Math.min(pending * 2, 100) / 100 * MAX_BAR_HEIGHT + "px";    
    barElements.rejected.style.height = Math.min(rejected * 2, 100) / 100 * MAX_BAR_HEIGHT + "px";    

    // Show empty states    
    showEmptyState(AvailableContainer, "No Available tasks yet");    
    showEmptyState(completedContainer, "No completed tasks");    
    showEmptyState(rejectedContainer, "No rejected tasks");    
    showEmptyState(pendingContainer, "No pending tasks");    
    showEmptyState(flaggedContainer, "No flagged tasks");    
  });    
}
 // ---------------- BUTTON LOADING ----------------
function setButtonLoading(btn, loading, text = "Submit Task") {
  if (loading) {
    btn.dataset.originalText = btn.textContent;
    btn.innerHTML = `<span class="spinner"></span>`;
    btn.classList.add("loading");
    btn.disabled = true;
  } else {
    btn.textContent = text || btn.dataset.originalText;
    btn.classList.remove("loading");
    btn.disabled = false;
  }
}

// ---------------- PROMISE TIMEOUT ----------------
function withTimeout(promise, ms = 60000) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Upload timeout")), ms)
    )
  ]);
} 
// ---------------- AUTH STATE ----------------  
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "1page.html";
    return;
  }

  try {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
      window.location.href = "no_access.html";
      return;
    }

    const data = snap.data();

    // âŒ Not an earner
    if (data.role !== REQUIRED_ROLE) {
      window.location.href = "no_access.html";
      return;
    }

    // ðŸš« ACCOUNT BANNED CHECK (EARâ€‹NER ONLY)
    if (data.accountStatus === "banned" || (data.stats?.flagged ?? 0) >= 99) {
      document.body.innerHTML = `
        <div style="
          position:fixed;
          inset:0;
          background:#000;
          color:#fff;
          display:flex;
          flex-direction:column;
          justify-content:center;
          align-items:center;
          text-align:center;
          padding:20px;
          z-index:9999;
        ">
          <h1 style="color:red;">Account Disabled</h1>
          <p>Your account has been disabled due to repeated flagged tasks.</p>
        </div>
      `;
      return;
    }

    // ðŸ‘¤ USER INFO
    usernameDisplay.textContent = data.name || "user";
    balanceDisplay.textContent = "â‚¦" + (data.balance ?? 10.30).toLocaleString();

    // ðŸ“Š STATS INIT (EARâ€‹NER SAFE)
    if (!data.stats) {
      const defaultStats = {
        Available: 0,
        completed: 0,
        pending: 0,
        rejected: 0,
        flagged: 0
      };

      await setDoc(userRef, { stats: defaultStats }, { merge: true });
      data.stats = defaultStats;
    }

    // ðŸ“ˆ RENDER STAT BARS (READ ONLY)
    Object.keys(barElements).forEach(stat => {
      const percent = data.stats?.[stat] ?? 0;
      barElements[stat].style.height =
        (Math.min(percent, 100) / 100) * MAX_BAR_HEIGHT + "px";
    });

    // ðŸ“¥ LOAD TASKS
    loadTasksForEarner();

  } catch (err) {
    console.error("Error loading user:", err);
    window.location.href = "no_access.html";
  }
});
// ---------------- REPORT MODAL ----------------  
const reportModal = document.getElementById("reportModal");  
const closeReportBtn = document.getElementById("closeReport");  
const submitReportBtn = document.getElementById("submitReport");  
let reportedTaskId = null;  
  
function openReportModal(taskId) {  
  reportedTaskId = taskId;  
  reportModal.style.display = "flex";  
}  
  
closeReportBtn.addEventListener("click", () => {  
  reportModal.style.display = "none";  
  reportedTaskId = null;  
});  
  
submitReportBtn.addEventListener("click", async () => {  
  const selected = document.querySelector('input[name="reportReason"]:checked');  
  if (!selected) { await showAlertModal("Please select a reason"); return; }  
  
  try {  
    const user = auth.currentUser;  
    const userSnap = await getDoc(doc(db, "users", user.uid));  
    const userData = userSnap.data();  
    const taskRef = doc(db, "tasks", reportedTaskId);  
    const taskSnap = await getDoc(taskRef);  
    const taskData = taskSnap.data();  
  
    await updateDoc(taskRef, {  
      status: "Suspended",  
      suspension: {  
        reason: selected.value,  
        reportedBy: user.uid,  
        reportedByName: userData.name || "Unknown",  
        projectCode: taskData.projectCode || null,  
        link: taskData.link || null,  
        description: taskData.description || null,  
        suspendedAt: new Date()  
      }  
    });  
  
    await showAlertModal("Task has been suspended and sent to admin review");  
    reportModal.style.display = "none";  
    reportedTaskId = null;  
  
  } catch (err) {  
    console.error("Suspend error:", err);  
    await showAlertModal("Failed to suspend task");  
  }  
});  
</script> 
</body>  
</html>